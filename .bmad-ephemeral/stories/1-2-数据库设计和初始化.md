# Story 1.2: 数据库设计和初始化

Status: done

## Story

As a **developer**,  
I want **to design and initialize the PostgreSQL database schema**,  
So that **I can store users, articles, comments, and other data**.

## Acceptance Criteria

Based on Epic 1 Story 1.2 and Tech Spec AC-1.2.1 through AC-1.2.6:

1. **AC-1.2.1:** `prisma/schema.prisma` file exists, containing all required table definitions
2. **AC-1.2.2:** Schema contains User, Article, Category, Tag, ArticleTag, Comment models
3. **AC-1.2.3:** All foreign key relationships are properly defined (User → Articles, Article → Category, Article → Tags, Article → Comments)
4. **AC-1.2.4:** Performance indexes are created (articles.publishedAt, articles.slug, articles.authorId, comments.articleId, comments.parentId)
5. **AC-1.2.5:** Execute `npx prisma migrate dev` successfully creates database and tables
6. **AC-1.2.6:** Database migration files are generated in `prisma/migrations/` directory

## Tasks / Subtasks

- [x] **Task 1: Install Prisma Dependencies** (AC: 1.2.1)
  - [x] Install `prisma` and `@prisma/client` packages
  - [x] Verify packages are added to `package.json`
  - [x] Run `npm install` to install dependencies
  - [x] Reference: [Source: docs/architecture/development-environment.md]

- [x] **Task 2: Initialize Prisma** (AC: 1.2.1)
  - [x] Run `npx prisma init` to initialize Prisma
  - [x] Verify `prisma/` directory is created
  - [x] Verify `prisma/schema.prisma` file is created
  - [x] Verify `.env.example` contains `DATABASE_URL` template (already exists from Story 1.1)
  - [x] Reference: [Source: docs/architecture/development-environment.md]

- [x] **Task 3: Design Database Schema** (AC: 1.2.2, 1.2.3)
  - [x] Create User model with fields: id, email, name, image, role, createdAt, updatedAt
  - [x] Create Role enum (USER, ADMIN)
  - [x] Create Article model with fields: id, title, content, excerpt, slug, status, categoryId, authorId, publishedAt, createdAt, updatedAt
  - [x] Create ArticleStatus enum (DRAFT, PUBLISHED)
  - [x] Create Category model with fields: id, name, slug
  - [x] Create Tag model with fields: id, name, slug
  - [x] Create ArticleTag junction model with fields: articleId, tagId
  - [x] Create Comment model with fields: id, content, articleId, userId, parentId, createdAt, updatedAt
  - [x] Define all foreign key relationships
  - [x] Reference: [Source: docs/architecture/data-architecture.md]
  - [x] Reference: [Source: .bmad-ephemeral/stories/tech-spec-epic-1.md#Data-Models-and-Contracts]

- [x] **Task 4: Configure Database Connection** (AC: 1.2.1)
  - [x] Update `prisma/schema.prisma` with PostgreSQL provider
  - [x] Configure `datasource db` with PostgreSQL provider
  - [x] Set `generator client` to generate Prisma Client
  - [x] Verify `DATABASE_URL` is configured in `.env.example` (already exists from Story 1.1)
  - [x] Reference: [Source: docs/architecture/data-architecture.md]

- [x] **Task 5: Add Performance Indexes** (AC: 1.2.4)
  - [x] Add `@@index([publishedAt])` to Article model
  - [x] Add `@@index([slug])` to Article model (already unique, but explicit index)
  - [x] Add `@@index([authorId])` to Article model
  - [x] Add `@@index([articleId])` to Comment model
  - [x] Add `@@index([parentId])` to Comment model
  - [x] Reference: [Source: docs/architecture/data-architecture.md#Indexes]

- [x] **Task 6: Run Database Migration** (AC: 1.2.5, 1.2.6)
  - [x] Ensure PostgreSQL database is running and accessible (Neon cloud database configured)
  - [x] Verify `DATABASE_URL` in `.env.local` points to correct database
  - [x] Run `npx prisma migrate dev --name init` to create initial migration
  - [x] Verify migration file is created in `prisma/migrations/` directory
  - [x] Verify database tables are created successfully
  - [x] Verify all foreign key constraints are applied
  - [x] Reference: [Source: docs/architecture/development-environment.md]

- [x] **Task 7: Verify Schema and Relationships** (AC: 1.2.2, 1.2.3)
  - [x] Verify all models are defined correctly
  - [x] Verify all relationships are properly configured
  - [x] Verify all enums are defined
  - [x] Verify all required fields have appropriate types
  - [x] Verify all optional fields are marked with `?`
  - [x] Run `npx prisma validate` to validate schema
  - [x] Reference: [Source: docs/architecture/data-architecture.md]

- [x] **Task 8: Generate Prisma Client** (Testing)
  - [x] Run `npx prisma generate` to generate Prisma Client
  - [x] Verify `node_modules/.prisma/client/` is created
  - [x] Verify TypeScript types are generated correctly
  - [x] Note: Prisma Client usage will be implemented in Story 1.3
  - [x] Reference: [Source: docs/architecture/development-environment.md]

## Dev Notes

### Architecture Patterns and Constraints

**Database ORM Decision:**
- Must use Prisma as ORM (architecture decision)
- Prisma provides type-safe database access
- Prisma Migrate handles database migrations
- Reference: [Source: docs/architecture/decision-summary.md]

**Database Schema Design:**
- All models must use `cuid()` for primary keys (String type)
- All DateTime fields must use `@default(now())` for createdAt
- All DateTime fields must use `@updatedAt` for updatedAt
- All dates must be stored in UTC
- Reference: [Source: docs/architecture/data-architecture.md]

**Foreign Key Relationships:**
- User → Articles: One-to-Many (authorId in Article)
- User → Comments: One-to-Many (userId in Comment)
- Article → Category: Many-to-One (categoryId in Article)
- Article → Tags: Many-to-Many (via ArticleTag junction table)
- Article → Comments: One-to-Many (articleId in Comment)
- Comment → Comment: Self-referential for replies (parentId in Comment)
- Reference: [Source: docs/architecture/data-architecture.md#Data-Relationships]

**Performance Indexes:**
- Must create indexes on frequently queried columns
- Indexes: articles.publishedAt, articles.slug, articles.authorId, comments.articleId, comments.parentId
- Reference: [Source: docs/architecture/data-architecture.md#Indexes]

**Code Documentation:**
- Prisma schema file should include comments explaining each model
- All public functions, interfaces, and classes MUST include JSDoc comments
- Reference: [Source: docs/architecture/implementation-patterns.md#Code-Documentation]

**Error Handling:**
- Prisma automatically handles SQL injection via parameterized queries
- Database connection errors should be handled gracefully
- Reference: [Source: docs/architecture/implementation-patterns.md#Error-Handling]

### Project Structure Notes

**Alignment with Architecture:**
- Prisma schema file: `prisma/schema.prisma`
- Migration files: `prisma/migrations/`
- Prisma Client will be generated to `node_modules/.prisma/client/`
- Database connection module will be created in Story 1.3: `lib/db/prisma.ts`
- Reference: [Source: docs/architecture/project-structure.md]

**Directory Creation:**
- `prisma/` - Will be created by `npx prisma init`
- `prisma/migrations/` - Will be created by `npx prisma migrate dev`

**Future Directories (Not in this story):**
- `lib/db/` - Will be created in Story 1.3 for Prisma Client connection

### Learnings from Previous Story

**From Story 1.1 (Status: done)**

- **项目结构已建立：** 项目已成功初始化，所有基础目录（app/, components/, lib/, public/）已创建
- **环境变量模板：** `.env.example` 已创建，包含 `DATABASE_URL` 模板
- **TypeScript 配置：** `tsconfig.json` 已配置，strict mode 已启用，路径别名已配置
- **项目依赖：** Next.js 16.0.2, React 19.2.0, TypeScript ^5 已安装
- **代码规范：** JSDoc 注释标准已建立，所有公共函数和接口需要 JSDoc 注释

**可复用的文件和模式：**
- `.env.example` - 已包含 `DATABASE_URL` 模板，可直接使用
- `package.json` - 需要添加 Prisma 依赖
- `tsconfig.json` - 已配置，支持 TypeScript 类型检查

**技术决策：**
- Tailwind CSS v4 使用 CSS-first 配置（不需要 tailwind.config.js）
- 项目使用 Next.js App Router 结构

**注意事项：**
- 确保 `.env.local` 文件已创建并配置正确的 `DATABASE_URL`
- Prisma Client 生成后，TypeScript 类型将自动可用

[Source: .bmad-ephemeral/stories/1-1-项目初始化和基础配置.md#Dev-Agent-Record]

### References

- **Epic Definition:** [Source: docs/epics/epic-1-项目基础架构foundation.md#Story-12-数据库设计和初始化]
- **Tech Spec:** [Source: .bmad-ephemeral/stories/tech-spec-epic-1.md#Story-12-数据库设计和初始化]
- **Architecture - Data Architecture:** [Source: docs/architecture/data-architecture.md]
- **Architecture - Development Environment:** [Source: docs/architecture/development-environment.md]
- **Architecture - Decision Summary:** [Source: docs/architecture/decision-summary.md]
- **PRD - Functional Requirements:** [Source: docs/PRD/functional-requirements.md]

## Dev Agent Record

### Context Reference

- `.bmad-ephemeral/stories/1-2-数据库设计和初始化.context.xml` (generated: 2025-11-12 16:09:29)

### Agent Model Used

Auto (Cursor AI Assistant)

### Debug Log References

**Task 1: Install Prisma Dependencies**
- Command: `npm install prisma @prisma/client --save-dev`
- Result: Successfully installed prisma@^6.19.0 and @prisma/client@^6.19.0
- Verified: Packages added to `package.json` devDependencies

**Task 2: Initialize Prisma**
- Command: `npx prisma init`
- Result: Created `prisma/schema.prisma` and `prisma.config.ts`
- Verified: `prisma/` directory created, schema file exists
- Note: `.env.example` already contains `DATABASE_URL` template from Story 1.1

**Task 3-5: Design Database Schema, Configure Connection, Add Indexes**
- Created complete Prisma schema with:
  - 2 Enums: `Role` (USER, ADMIN), `ArticleStatus` (DRAFT, PUBLISHED)
  - 6 Models: User, Article, Category, Tag, ArticleTag, Comment
  - All foreign key relationships properly defined
  - All performance indexes added (articles.publishedAt, articles.slug, articles.authorId, comments.articleId, comments.parentId)
  - All models use `cuid()` for primary keys
  - All DateTime fields use `@default(now())` and `@updatedAt`
  - All models include JSDoc comments explaining purpose and relationships

**Task 7: Verify Schema and Relationships**
- Command: `DATABASE_URL="postgresql://user:password@localhost:5432/travis_blog" npx prisma validate`
- Result: ✅ Schema validation passed
- Verified: All models, relationships, enums, and indexes are correctly defined

**Task 8: Generate Prisma Client**
- Command: `DATABASE_URL="postgresql://user:password@localhost:5432/travis_blog" npx prisma generate`
- Result: ✅ Prisma Client generated successfully to `./node_modules/@prisma/client`
- Verified: TypeScript types generated correctly
- Verified: `node_modules/.prisma/client/` directory exists

**Task 6: Run Database Migration**
- Command: `npx prisma migrate dev --name init`
- Database: Neon cloud database (travis-blog)
- Result: ✅ Migration successfully created and applied
- Migration file: `prisma/migrations/20251112212426_init/migration.sql`
- Verified: All database tables created successfully with foreign key constraints
- Note: Database connection configured in `.env.local` using Neon connection string for `travis-blog` database

### Completion Notes List

1. **Prisma Schema Design Complete**: All 6 models (User, Article, Category, Tag, ArticleTag, Comment) and 2 enums (Role, ArticleStatus) are defined with complete relationships and indexes.

2. **Schema Validation Passed**: `npx prisma validate` confirms schema syntax is correct and all relationships are properly configured.

3. **Prisma Client Generated**: TypeScript types are available for use in Story 1.3.

4. **Database Migration Complete**: Task 6 successfully completed. Migration file created and applied to Neon cloud database. All tables and foreign key constraints are in place.

5. **Code Documentation**: All Prisma models include JSDoc comments explaining purpose, relationships, and usage.

6. **Architecture Alignment**: Schema design fully aligns with `docs/architecture/data-architecture.md` specifications.

### File List

**Created Files:**
- `prisma/schema.prisma` - Complete database schema with all models, enums, relationships, and indexes
- `prisma.config.ts` - Prisma configuration file (generated by `npx prisma init`)

**Modified Files:**
- `package.json` - Added `prisma` and `@prisma/client` to devDependencies

**Generated Files:**
- `node_modules/.prisma/client/` - Prisma Client with TypeScript types (generated by `npx prisma generate`)

**Created Files (Migration):**
- `prisma/migrations/20251112212426_init/migration.sql` - Initial database migration file
- `.env.local` - Local environment variables with Neon database connection string

---

## Senior Developer Review (AI)

**Reviewer:** Travis  
**Date:** 2025-11-12 16:26:52  
**Outcome:** ✅ **APPROVE**

### Summary

Story 1.2 的实施质量优秀，所有 Acceptance Criteria 均已完全实现，所有标记为完成的任务都已验证完成。数据库 Schema 设计完整，符合架构规范，迁移成功应用到 Neon 云数据库。代码质量高，文档完善，为后续开发奠定了坚实的基础。

**关键亮点：**
- ✅ 所有 6 个 Acceptance Criteria 完全实现
- ✅ 所有 8 个任务及其子任务均已完成并验证
- ✅ Prisma Schema 设计完整，包含所有必需模型、枚举、关系和索引
- ✅ 数据库迁移成功应用，所有表和外键约束已创建
- ✅ 代码符合架构规范和编码标准
- ✅ JSDoc 注释完整，文档清晰

### Key Findings

**无严重问题发现**

所有实现均符合要求，未发现需要阻塞的问题。

### Acceptance Criteria Coverage

| AC# | Description | Status | Evidence |
|-----|-------------|--------|----------|
| **AC-1.2.1** | `prisma/schema.prisma` file exists, containing all required table definitions | ✅ **IMPLEMENTED** | `prisma/schema.prisma:1-170` - Schema file exists with complete table definitions |
| **AC-1.2.2** | Schema contains User, Article, Category, Tag, ArticleTag, Comment models | ✅ **IMPLEMENTED** | `prisma/schema.prisma:48-169` - All 6 models defined (User:48, Article:106, Category:69, Tag:86, ArticleTag:133, Comment:152) |
| **AC-1.2.3** | All foreign key relationships are properly defined | ✅ **IMPLEMENTED** | `prisma/schema.prisma:119-164` - All 8 relationships defined with @relation directives. Verified in migration: `prisma/migrations/20251112212426_init/migration.sql:113-132` |
| **AC-1.2.4** | Performance indexes are created | ✅ **IMPLEMENTED** | `prisma/schema.prisma:124-127,166-167` - All 5 indexes defined: articles.publishedAt, articles.slug, articles.authorId, comments.articleId, comments.parentId. Verified in migration: `prisma/migrations/20251112212426_init/migration.sql:99-111` |
| **AC-1.2.5** | Execute `npx prisma migrate dev` successfully creates database and tables | ✅ **IMPLEMENTED** | Migration file `prisma/migrations/20251112212426_init/migration.sql` contains all CREATE TABLE statements. Migration successfully applied to Neon database (travis-blog) |
| **AC-1.2.6** | Database migration files are generated in `prisma/migrations/` directory | ✅ **IMPLEMENTED** | `prisma/migrations/20251112212426_init/migration.sql` exists. Directory structure verified: `prisma/migrations/` contains migration folder and `migration_lock.toml` |

**AC Coverage Summary:** 6 of 6 acceptance criteria fully implemented (100%)

### Task Completion Validation

| Task | Marked As | Verified As | Evidence |
|------|-----------|-------------|----------|
| **Task 1: Install Prisma Dependencies** | ✅ Complete | ✅ **VERIFIED COMPLETE** | `package.json:17,24` - prisma@^6.19.0 and @prisma/client@^6.19.0 in devDependencies |
| **Task 2: Initialize Prisma** | ✅ Complete | ✅ **VERIFIED COMPLETE** | `prisma/schema.prisma:1-11` - Prisma initialized, schema file exists. `prisma.config.ts` exists |
| **Task 3: Design Database Schema** | ✅ Complete | ✅ **VERIFIED COMPLETE** | `prisma/schema.prisma:13-169` - All models and enums defined: User (48-61), Article (106-128), Category (69-78), Tag (86-95), ArticleTag (133-141), Comment (152-169), Role enum (22-25), ArticleStatus enum (32-35) |
| **Task 4: Configure Database Connection** | ✅ Complete | ✅ **VERIFIED COMPLETE** | `prisma/schema.prisma:8-11` - PostgreSQL provider configured, generator client set. `.env.local` contains DATABASE_URL |
| **Task 5: Add Performance Indexes** | ✅ Complete | ✅ **VERIFIED COMPLETE** | `prisma/schema.prisma:124-127,166-167` - All 5 indexes defined. Verified in migration SQL: `prisma/migrations/20251112212426_init/migration.sql:99-111` |
| **Task 6: Run Database Migration** | ✅ Complete | ✅ **VERIFIED COMPLETE** | Migration file `prisma/migrations/20251112212426_init/migration.sql` exists and contains all CREATE TABLE, CREATE INDEX, and AddForeignKey statements. Migration successfully applied to Neon database |
| **Task 7: Verify Schema and Relationships** | ✅ Complete | ✅ **VERIFIED COMPLETE** | Schema validation passed (verified via `npx prisma validate`). All models, relationships, enums correctly defined. All required fields have appropriate types, optional fields marked with `?` |
| **Task 8: Generate Prisma Client** | ✅ Complete | ✅ **VERIFIED COMPLETE** | `node_modules/.prisma/client/` directory exists. Prisma Client generated successfully |

**Task Completion Summary:** 8 of 8 completed tasks verified (100%), 0 questionable, 0 false completions

### Test Coverage and Gaps

**Testing Status:**
- Schema validation: ✅ Verified via `npx prisma validate`
- Migration execution: ✅ Verified via successful migration application
- Database table creation: ✅ Verified via migration SQL containing all CREATE TABLE statements
- Foreign key constraints: ✅ Verified via migration SQL containing all AddForeignKey statements

**Test Coverage Notes:**
- Manual verification performed for all ACs
- Migration file validates schema correctness
- Database connection and table creation verified through successful migration application
- No unit/integration tests required for this foundational story (testing framework setup in later stories)

### Architectural Alignment

**Tech Spec Compliance:**
- ✅ All models use `cuid()` for primary keys (String type) - Verified: `prisma/schema.prisma:49,70,87,107,134,153`
- ✅ All DateTime fields use `@default(now())` for createdAt - Verified: `prisma/schema.prisma:54,73,90,116,158`
- ✅ All DateTime fields use `@updatedAt` for updatedAt - Verified: `prisma/schema.prisma:55,74,91,117,159`
- ✅ All dates stored in UTC (PostgreSQL default) - Verified: Migration uses TIMESTAMP(3) which stores in UTC
- ✅ All foreign key relationships properly defined - Verified: `prisma/schema.prisma:119-164`
- ✅ All performance indexes created - Verified: `prisma/schema.prisma:124-127,166-167`

**Architecture Document Compliance:**
- ✅ Prisma ORM used (architecture decision) - Verified: `prisma/schema.prisma:1-11`
- ✅ PostgreSQL provider configured - Verified: `prisma/schema.prisma:8-10`
- ✅ Schema file location correct: `prisma/schema.prisma` - Verified: File exists at correct path
- ✅ Migration files location correct: `prisma/migrations/` - Verified: Directory exists with migration file
- ✅ All models include JSDoc comments - Verified: `prisma/schema.prisma:17-21,27-31,41-47,63-68,80-85,97-105,130-132,143-151`

**No Architecture Violations Found**

### Security Notes

**Security Review:**
- ✅ Prisma automatically handles SQL injection via parameterized queries (built-in protection)
- ✅ Database connection string stored in `.env.local` (not committed to Git - verified: `.gitignore:28-29`)
- ✅ Foreign key constraints enforce referential integrity
- ✅ Cascade delete policies properly configured (onDelete: Cascade for required relationships, SetNull for optional)
- ✅ Unique constraints on email, slug fields prevent duplicates
- ✅ No hardcoded credentials or sensitive data in code

**Security Best Practices:**
- Database connection uses SSL (sslmode=require in connection string)
- Environment variables properly isolated in `.env.local`
- Prisma Client generation does not expose sensitive information

### Best-Practices and References

**Prisma Best Practices:**
- ✅ Using `cuid()` for primary keys (better than auto-increment for distributed systems)
- ✅ Proper use of `@default(now())` and `@updatedAt` for timestamp management
- ✅ Cascade delete policies configured appropriately
- ✅ Indexes on frequently queried columns for performance
- ✅ JSDoc comments on all models for documentation

**References:**
- Prisma Schema Reference: https://www.prisma.io/docs/reference/api-reference/prisma-schema-reference
- Prisma Migrate Guide: https://www.prisma.io/docs/concepts/components/prisma-migrate
- Neon PostgreSQL Documentation: https://neon.tech/docs

### Action Items

**Code Changes Required:**
- None - All requirements met

**Advisory Notes:**
- Note: Consider adding database seed script in future stories for development data
- Note: Monitor database connection pool usage in production (Prisma handles this automatically)
- Note: Consider adding database backup strategy documentation in deployment story
- Note: Future stories should implement database connection error handling in application code (Story 1.3)

---
