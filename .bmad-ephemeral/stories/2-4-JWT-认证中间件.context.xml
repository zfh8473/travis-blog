<story-context id=".bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>2</epicId>
    <storyId>2.4</storyId>
    <title>JWT 认证中间件</title>
    <status>drafted</status>
    <generatedAt>2025-11-12</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>.bmad-ephemeral/stories/2-4-JWT-认证中间件.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>developer</asA>
    <iWant>to implement JWT authentication middleware</iWant>
    <soThat>protected routes can verify user authentication</soThat>
    <tasks>
      <task id="1" ac="2.4.1,2.4.2,2.4.3,2.4.4,2.4.5">Create Next.js Middleware for JWT Authentication</task>
      <task id="2" ac="2.4.1,2.4.4">Implement Token Extraction and Verification</task>
      <task id="3" ac="2.4.2">Attach User Information to Request Context</task>
      <task id="4" ac="2.4.1,2.4.3,2.4.4">Protect API Routes</task>
      <task id="5" ac="2.4.1,2.4.3,2.4.4,2.4.5">Protect Pages and Routes</task>
      <task id="6" ac="2.4.4,2.4.5">Implement Error Handling</task>
      <task id="7" ac="all">Testing</task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <ac id="2.4.1">Given a user makes a request to a protected route, When the request includes a valid JWT token, Then the user is authenticated</ac>
    <ac id="2.4.2">The user information is available in the request context</ac>
    <ac id="2.4.3">The request proceeds normally</ac>
    <ac id="2.4.4">When the request includes an invalid or expired token, Then the request is rejected with 401 Unauthorized</ac>
    <ac id="2.4.5">The user is redirected to login</ac>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc path="docs/epics/epic-2-用户认证和授权user-authentication-authorization.md" title="Epic 2: 用户认证和授权" section="Story 2.4">
        Story definition with acceptance criteria and technical notes for JWT authentication middleware. Includes requirements for JWT verification, token extraction from httpOnly cookie or Authorization header, user information attachment to request context, and route protection.
      </doc>
      <doc path="docs/architecture.md" title="Architecture Document" section="Security Architecture">
        Security architecture requirements including NextAuth.js JWT session strategy, httpOnly cookie storage, token expiration (30 days), and middleware-based route protection. Specifies role-based access control with middleware protection for admin routes.
      </doc>
      <doc path="docs/architecture.md" title="Architecture Document" section="Authorization">
        Role-based access control requirements. Admin routes protected with middleware. Admin actions check role before execution. Roles: USER (default), ADMIN.
      </doc>
      <doc path="docs/architecture.md" title="Architecture Document" section="API Contracts">
        Unified error response format: { success: boolean, error?: { message: string, code: string } }. HTTP status codes: 200 (Success), 401 (Unauthorized), 403 (Forbidden), 400 (Bad Request).
      </doc>
      <doc path="docs/architecture.md" title="Architecture Document" section="Project Structure">
        Project structure guidelines. Middleware file should be placed at project root as `middleware.ts`. Protected API routes: `app/api/admin/*`, `app/api/articles/*`. Protected pages: `app/admin/*`.
      </doc>
      <doc path="docs/PRD.md" title="Product Requirements Document" section="FR-1.3 JWT 认证中间件">
        Functional requirement for JWT authentication middleware to protect routes and verify user authentication. Includes token verification, user context attachment, and error handling.
      </doc>
      <doc path=".bmad-ephemeral/stories/2-3-用户登录功能（邮箱密码登录）.md" title="Story 2.3: 用户登录功能" section="Dev Agent Record">
        Learnings from login story: NextAuth.js JWT configuration with 30-day expiration, JWT token stored in httpOnly cookie (`next-auth.session-token`), token contains user information (id, email, name, role) from JWT callback, session callback attaches user data to session object.
      </doc>
      <doc path=".bmad-ephemeral/stories/2-3-用户登录功能（邮箱密码登录）.md" title="Story 2.3: 用户登录功能" section="Senior Developer Review">
        Review findings: All acceptance criteria implemented, code quality good, follows architecture constraints, security implementation correct. JWT token generation and storage working correctly.
      </doc>
    </docs>
    <code>
      <artifact path="app/api/auth/[...nextauth]/route.ts" kind="configuration" symbol="authOptions" lines="40-281" reason="NextAuth.js configuration with JWT session strategy. Contains JWT callback that adds user information (id, email, name, role) to token. Session callback attaches user data to session object. Token stored in httpOnly cookie with 30-day expiration." />
      <artifact path="app/api/auth/[...nextauth]/route.ts" kind="function" symbol="jwt" lines="225-262" reason="JWT callback that adds user information to token. For Credentials provider, uses user data from authorize function. For OAuth providers, fetches from database. Token contains: id, email, name, image, role." />
      <artifact path="app/api/auth/[...nextauth]/route.ts" kind="function" symbol="session" lines="264-274" reason="Session callback that attaches user data (id, email, name, image, role) to session object accessible via useSession hook." />
      <artifact path="app/api/auth/[...nextauth]/route.ts" kind="configuration" symbol="cookies" lines="127-137" reason="Cookie configuration for JWT token storage. Session token stored in httpOnly cookie named `next-auth.session-token`. Secure in production, sameSite: lax, path: /." />
      <artifact path="types/next-auth.d.ts" kind="type-definition" symbol="JWT" reason="TypeScript type definitions for NextAuth.js JWT token. Extends default JWT interface with custom fields: id, email, name, image, role. Used for type safety in middleware token extraction." />
      <artifact path="types/next-auth.d.ts" kind="type-definition" symbol="Session" reason="TypeScript type definitions for NextAuth.js Session. Extends default Session interface with custom user fields: id, email, name, image, role. Used for type safety in session access." />
      <artifact path="app/providers.tsx" kind="component" symbol="Providers" reason="SessionProvider wrapper component that enables authentication context throughout the app. Wraps application with NextAuth SessionProvider to enable useSession hook." />
      <artifact path="app/login/page.tsx" kind="function" symbol="handleSubmit" lines="113-115" reason="Login redirect logic that redirects to callbackUrl or homepage after successful login. Uses Next.js router.push() and router.refresh(). Preserves callbackUrl for redirect after authentication." />
    </code>
    <dependencies>
      <ecosystem name="Node.js">
        <package name="next" version="16.0.2" />
        <package name="next-auth" version="^4.24.13" />
        <package name="react" version="19.2.0" />
        <package name="react-dom" version="19.2.0" />
      </ecosystem>
      <ecosystem name="Testing">
        <package name="jest" version="^30.2.0" />
        <package name="jest-environment-jsdom" version="^30.2.0" />
        <package name="ts-jest" version="^29.4.5" />
        <package name="@testing-library/react" version="^16.3.0" />
        <package name="@testing-library/jest-dom" version="^6.9.1" />
        <package name="@playwright/test" version="^1.56.1" />
      </ecosystem>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint type="authentication">Must use NextAuth.js getToken function to extract and verify JWT tokens in middleware. Token stored in httpOnly cookie named `next-auth.session-token`. Token expiration: 30 days (from Story 2.3). Token contains user information (id, email, name, role) from JWT callback.</constraint>
    <constraint type="middleware">Next.js middleware must be placed at project root as `middleware.ts`. Middleware runs before request completion. Can access request headers, cookies, and modify response. Configure matcher to specify which routes to protect.</constraint>
    <constraint type="token-extraction">Extract token from httpOnly cookie (NextAuth.js session token) as primary method. Extract from Authorization header (Bearer token) as fallback for API clients. Use NextAuth.js getToken function for extraction and verification.</constraint>
    <constraint type="token-verification">Verify token signature using NEXTAUTH_SECRET. Check token expiration (30 days). Validate token structure matches NextAuth.js JWT format (contains user id, email, role).</constraint>
    <constraint type="request-context">Attach user information to Next.js request object. Make user information available in API routes and Server Components. Use TypeScript types from types/next-auth.d.ts for type safety.</constraint>
    <constraint type="route-protection">Protect API routes: /api/admin/*, /api/articles/* (for authenticated users). Protect pages: /admin/*. Use middleware matcher to specify protected routes. Redirect unauthenticated users to /login?callbackUrl={originalUrl}.</constraint>
    <constraint type="error-handling">Invalid token → 401 Unauthorized. Expired token → 401 Unauthorized. Missing token → 401 Unauthorized, redirect to login. Return JSON error response for API routes. Redirect to login page with error message for pages. Log authentication failures for security monitoring.</constraint>
    <constraint type="api">Follow unified error response format: { success: boolean, error?: { message: string, code: string } }. Use HTTP status codes: 401 (Unauthorized) for authentication failures, 403 (Forbidden) for permission failures.</constraint>
    <constraint type="testing">Unit tests required for token extraction and verification. Integration tests required for middleware (valid token, invalid token, expired token, missing token scenarios). Test protected API routes and pages. Use Jest for unit/integration tests, Playwright for E2E tests.</constraint>
  </constraints>

  <interfaces>
    <interface name="NextAuth.js getToken" kind="utility-function" signature="getToken({ req, secret }): Promise&lt;JWT | null&gt;" path="next-auth/jwt" />
    <interface name="Next.js Middleware" kind="middleware-function" signature="export function middleware(request: NextRequest): NextResponse | Response" path="middleware.ts" />
    <interface name="NextRequest" kind="request-object" signature="NextRequest extends Request with Next.js specific properties (cookies, headers, url)" path="next/server" />
    <interface name="NextResponse" kind="response-object" signature="NextResponse extends Response with Next.js specific methods (redirect, json, cookies)" path="next/server" />
    <interface name="JWT Token" kind="token-object" signature="{ id: string, email: string, name: string | null, image: string | null, role: string, exp: number, iat: number }" path="types/next-auth.d.ts" />
    <interface name="Session" kind="session-object" signature="{ user: { id: string, email: string, name: string | null, image: string | null, role: string } }" path="types/next-auth.d.ts" />
  </interfaces>

  <tests>
    <standards>
      Testing uses Jest for unit and integration tests, and Playwright for E2E tests. Unit tests should test token extraction and verification logic in isolation. Integration tests should test middleware behavior with real Next.js request/response objects. E2E tests should test complete user flows including protected route access. All tests should follow existing patterns from Story 2.3. Test files should be co-located with source files or in tests/ directory structure.
    </standards>
    <locations>
      <location>tests/__tests__/unit/</location>
      <location>tests/__tests__/integration/</location>
      <location>tests/e2e/</location>
    </locations>
    <ideas>
      <test ac="2.4.1" type="unit">Test token extraction from httpOnly cookie: extract `next-auth.session-token` cookie, verify cookie parsing, handle missing cookie.</test>
      <test ac="2.4.1" type="unit">Test token extraction from Authorization header: extract Bearer token, verify header parsing, handle missing header.</test>
      <test ac="2.4.1" type="unit">Test token verification: verify token signature using NEXTAUTH_SECRET, check token expiration, validate token structure.</test>
      <test ac="2.4.2" type="integration">Test user information attachment: verify user information (id, email, name, role) is attached to request context after token verification.</test>
      <test ac="2.4.3" type="integration">Test request proceeds normally: verify authenticated request proceeds to handler, verify user information available in API route handler.</test>
      <test ac="2.4.4" type="integration">Test invalid token rejection: verify request with invalid token is rejected with 401 Unauthorized, verify error response format.</test>
      <test ac="2.4.4" type="integration">Test expired token rejection: verify request with expired token is rejected with 401 Unauthorized, verify error response format.</test>
      <test ac="2.4.4" type="integration">Test missing token rejection: verify request without token is rejected with 401 Unauthorized, verify error response format.</test>
      <test ac="2.4.5" type="e2e">Test redirect to login: verify unauthenticated user accessing protected page is redirected to /login?callbackUrl={originalUrl}.</test>
      <test ac="2.4.1,2.4.3" type="integration">Test protected API route: verify authenticated request to /api/admin/* returns 200 OK, verify unauthenticated request returns 401 Unauthorized.</test>
      <test ac="2.4.1,2.4.3,2.4.5" type="e2e">Test protected page: verify authenticated user can access /admin/*, verify unauthenticated user is redirected to login with callbackUrl.</test>
      <test ac="all" type="e2e">Test complete authentication flow: login, access protected route, verify user information available, logout, verify protected route access denied.</test>
    </ideas>
  </tests>
</story-context>

