# Story 4.1: 文章列表页面（首页）

Status: done

## Story

As a **reader**,  
I want **to see a list of published articles on the homepage**,  
So that **I can discover and browse blog content**.

## Acceptance Criteria

Based on Epic 4 Story 4.1 from epics.md and tech-spec-epic-4.md:

1. **AC-4.1.1:** Given I visit the homepage, When the page loads, Then I see a list of published articles
2. **AC-4.1.2:** Each article shows title, excerpt, publish date, category, and tags
3. **AC-4.1.3:** Articles are sorted by publish date (newest first by default)
4. **AC-4.1.4:** Articles are paginated (default 20 per page, max 100)
5. **AC-4.1.5:** The page is responsive (works on desktop, tablet, mobile)
6. **AC-4.1.6:** Loading states are displayed while fetching articles
7. **AC-4.1.7:** Empty state is displayed when no articles are available

## Tasks / Subtasks

- [x] **Task 1: Create Homepage Server Component** (AC: 4.1.1, 4.1.6)
  - [x] Update `app/page.tsx` to be a Server Component
  - [x] Fetch published articles directly from database using Prisma (more efficient than API call in Server Component)
  - [x] Handle API errors gracefully
  - [x] Add loading state (using Suspense boundary)
  - [ ] Reference: [Source: docs/architecture.md#Project-Structure]
  - [ ] Reference: [Source: .bmad-ephemeral/stories/tech-spec-epic-4.md#Workflows-and-Sequencing]

- [x] **Task 2: Create Article List Component** (AC: 4.1.1, 4.1.2)
  - [x] Create `components/article/ArticleList.tsx` component
  - [x] Accept articles array as prop
  - [x] Render list of article cards
  - [x] Handle empty state (no articles)
  - [ ] Reference: [Source: docs/architecture.md#Component-Organization]

- [x] **Task 3: Create Article Card Component** (AC: 4.1.2)
  - [x] Create `components/article/ArticleCard.tsx` component
  - [x] Display article title
  - [x] Display article excerpt (or generate from content)
  - [x] Display publish date (formatted using date-fns)
  - [x] Display category (if available)
  - [x] Display tags (if available)
  - [x] Make card clickable (link to article detail page)
  - [ ] Reference: [Source: docs/architecture.md#Component-Organization]
  - [ ] Reference: [Source: .bmad-ephemeral/stories/tech-spec-epic-4.md#Data-Models-and-Contracts]

- [x] **Task 4: Implement Pagination Component** (AC: 4.1.4)
  - [x] Create `components/article/Pagination.tsx` Client Component
  - [x] Accept pagination metadata (page, limit, total, totalPages)
  - [x] Display current page and total pages
  - [x] Add "Previous" and "Next" buttons
  - [x] Add page number buttons (with ellipsis for many pages)
  - [x] Update URL query parameter when page changes
  - [x] Handle edge cases (first page, last page)
  - [x] Make pagination responsive (simplified on mobile)
  - [ ] Reference: [Source: .bmad-ephemeral/stories/tech-spec-epic-4.md#Workflows-and-Sequencing]

- [x] **Task 5: Implement Responsive Design** (AC: 4.1.5)
  - [x] Use Tailwind CSS responsive breakpoints (sm, md, lg, xl)
  - [x] Mobile-first design approach
  - [x] Article cards stack vertically on mobile
  - [x] Article cards display in grid on desktop
  - [x] Typography scales appropriately
  - [ ] Reference: [Source: docs/architecture.md#Styling-Architecture]

- [x] **Task 6: Implement Date Formatting** (AC: 4.1.2)
  - [x] Use date-fns library for date formatting
  - [x] Format publish date as localized string (e.g., "2025年11月14日")
  - [x] Handle timezone conversion if needed
  - [ ] Reference: [Source: docs/architecture.md#Date-Time-Handling]

- [x] **Task 7: Implement Article Sorting** (AC: 4.1.3)
  - [x] Articles sorted by `publishedAt` descending (newest first) by default
  - [x] Sorting handled in fetchArticles function using Prisma orderBy
  - [x] Verify articles are returned in correct order
  - [ ] Reference: [Source: app/api/articles/public/route.ts#orderBy]

- [x] **Task 8: Add Loading States** (AC: 4.1.6)
  - [x] Use Next.js Suspense boundary for loading state
  - [x] Display loading indicator while fetching articles
  - [ ] Reference: [Source: docs/architecture.md#Loading-States]

- [x] **Task 9: Handle Empty State** (AC: 4.1.7)
  - [x] Display friendly message when no articles available
  - [x] Suggest actions (e.g., "请稍后再来查看新文章")
  - [ ] Reference: [Source: .bmad-ephemeral/stories/tech-spec-epic-4.md#Reliability-Availability]

- [x] **Task 10: Add Error Handling** (AC: 4.1.1)
  - [x] Handle database errors gracefully
  - [x] Display user-friendly error messages
  - [x] Error state UI implemented
  - [ ] Reference: [Source: docs/architecture.md#Error-Handling]

- [x] **Task 11: Add Navigation to Article Detail** (AC: 4.1.2)
  - [x] Make article cards clickable
  - [x] Navigate to `/articles/[slug]` when clicked
  - [x] Use Next.js Link component for client-side navigation
  - [ ] Reference: [Source: docs/architecture.md#Navigation-Patterns]

- [x] **Task 12: Write Tests** (All ACs)
  - [x] Create unit tests for ArticleCard component
  - [x] Create unit tests for ArticleList component
  - [x] Create unit tests for Pagination component
  - [x] Create integration tests for homepage data fetching
  - [x] Create E2E tests for homepage article list display
  - [ ] Reference: [Source: .bmad-ephemeral/stories/tech-spec-epic-4.md#Test-Strategy-Summary]

## Dev Notes

### Relevant Architecture Patterns and Constraints

**Server Components:**
- Use Next.js Server Components for homepage to enable SSR and SEO
- Fetch data directly in Server Component using `fetch` API
- Use `async/await` for asynchronous data fetching
- Reference: [Source: docs/architecture.md#Next.js-App-Router]

**API Integration:**
- Use public API endpoint: `GET /api/articles/public`
- API already implements pagination, filtering, and sorting
- API returns unified response format: `{ success: boolean, data: T, error?: { message: string, code: string } }`
- Reference: [Source: app/api/articles/public/route.ts]

**Component Organization:**
- Article components in `components/article/` directory
- Follow naming convention: `PascalCase.tsx` for components
- Separate Server Components and Client Components appropriately
- Reference: [Source: docs/architecture.md#Component-Organization]

**Styling:**
- Use Tailwind CSS for all styling
- Mobile-first responsive design
- Use Tailwind responsive breakpoints: `sm:`, `md:`, `lg:`, `xl:`
- Reference: [Source: docs/architecture.md#Styling-Architecture]

**Error Handling:**
- Use unified error format from API
- Display user-friendly error messages
- Log errors for debugging (console in dev, structured in prod)
- Reference: [Source: docs/architecture.md#Error-Handling]

**Date Formatting:**
- Use `date-fns` library for date formatting
- Format dates in user's locale (Chinese)
- Handle timezone conversion if needed
- Reference: [Source: docs/architecture.md#Date-Time-Handling]

### Source Tree Components to Touch

**New Files:**
- `components/article/ArticleList.tsx` - Article list component
- `components/article/ArticleCard.tsx` - Article card component
- `components/article/Pagination.tsx` - Pagination component (Client Component)

**Modified Files:**
- `app/page.tsx` - Update homepage to display article list

**Test Files:**
- `tests/__tests__/unit/article-card.test.tsx` - ArticleCard unit tests
- `tests/__tests__/unit/article-list.test.tsx` - ArticleList unit tests
- `tests/__tests__/unit/pagination.test.tsx` - Pagination unit tests
- `tests/__tests__/integration/homepage.test.ts` - Homepage integration tests
- `tests/e2e/homepage.spec.ts` - Homepage E2E tests

### Testing Standards Summary

**Unit Tests:**
- Test component rendering with different props
- Test component interactions (clicks, navigation)
- Test edge cases (empty data, missing fields)
- Use React Testing Library for component tests

**Integration Tests:**
- Test API calls from Server Component
- Test data fetching and error handling
- Mock API responses for testing

**E2E Tests:**
- Test complete user flow: visit homepage → see articles → click article
- Test pagination navigation
- Test responsive design on different screen sizes
- Use Playwright for E2E tests

### Project Structure Notes

**Alignment with Unified Project Structure:**
- ✅ Components in `components/article/` directory (matches architecture)
- ✅ Pages in `app/` directory (Next.js App Router)
- ✅ Server Components for data fetching (performance and SEO)
- ✅ Client Components only when needed (interactivity)

**No Conflicts Detected:**
- Homepage (`app/page.tsx`) currently shows default Next.js template - will be replaced
- No existing article display components conflict with this story
- `app/articles/page.tsx` exists but is for different route - no conflict

### Learnings from Previous Story

**From Story 3.8: 媒体管理功能 (Status: done)**

- **New Service Created**: Public articles API endpoint already available at `app/api/articles/public/route.ts` - use `GET /api/articles/public?page=1&limit=20` for fetching articles
- **Component Patterns**: Follow patterns from `app/admin/articles/page.tsx` for article list display, but adapt for public-facing homepage
- **Pagination Implementation**: Pagination component pattern can be referenced from `app/admin/articles/page.tsx`, but needs to be adapted for public API
- **Responsive Design**: Use Tailwind CSS grid/flexbox patterns similar to media library page (`app/admin/media/page.tsx`)
- **Error Handling**: Follow unified error response format: `{ success: boolean, data: T, error?: { message: string, code: string } }`
- **Loading States**: Use Suspense boundaries for Server Components, similar to `app/articles/page.tsx`
- **File Structure**: Article-related components should go in `components/article/` directory

**Key Reusable Components/Patterns:**
- API error handling pattern from previous stories
- Responsive grid layout pattern from media library
- Pagination logic (can be adapted from admin articles page)

**Technical Debt/Considerations:**
- Performance: API already implements server-side pagination, which is good
- SEO: Using Server Components ensures good SEO for homepage
- Accessibility: Ensure article cards are keyboard navigable

[Source: .bmad-ephemeral/stories/3-8-媒体管理功能.md#Dev-Agent-Record]

### References

- **Epic Definition:** [Source: docs/epics/epic-4-内容展示content-display.md#Story-41-文章列表页面首页]
- **Technical Specification:** [Source: .bmad-ephemeral/stories/tech-spec-epic-4.md#Story-41-文章列表页面首页]
- **API Endpoint:** [Source: app/api/articles/public/route.ts]
- **Architecture:** [Source: docs/architecture.md#Project-Structure]
- **Component Patterns:** [Source: app/articles/page.tsx] (existing article list page for reference)
- **Pagination Pattern:** [Source: app/admin/articles/page.tsx] (admin articles page for pagination reference)

## Dev Agent Record

### Context Reference

- `.bmad-ephemeral/stories/4-1-文章列表页面（首页）.context.xml`

### Agent Model Used

{{agent_model_name_version}}

### Debug Log References

### Completion Notes List

**Implementation Summary:**
- ✅ Created homepage Server Component that fetches published articles directly from database using Prisma (more efficient than API calls in Server Components)
- ✅ Implemented ArticleCard component with all required fields (title, excerpt, date, category, tags, author)
- ✅ Implemented ArticleList component with responsive grid layout and empty state handling
- ✅ Implemented Pagination component as Client Component with URL parameter handling
- ✅ Added Suspense boundaries for loading states
- ✅ Implemented error handling with user-friendly messages
- ✅ Fixed nested anchor tag issue by making only title clickable (category and tags are separate links)
- ✅ All components use Tailwind CSS with mobile-first responsive design
- ✅ Date formatting using date-fns with Chinese locale
- ✅ Articles sorted by publishedAt descending (newest first)
- ✅ Comprehensive test coverage: 26 unit tests, integration tests, and E2E tests all passing

**Technical Decisions:**
- Used Prisma directly in Server Component instead of API calls for better performance
- Made Pagination a Client Component to use useSearchParams hook
- Fixed HTML structure to avoid nested anchor tags (only title is clickable, category/tags are separate links)
- Used Suspense boundaries for both article list and pagination loading states

### File List

**New Files:**
- `components/article/ArticleCard.tsx` - Article card component with title, excerpt, date, category, tags
- `components/article/ArticleList.tsx` - Article list component with grid layout and empty state
- `components/article/Pagination.tsx` - Pagination component (Client Component) with page navigation
- `tests/__tests__/unit/article-card.test.tsx` - Unit tests for ArticleCard component
- `tests/__tests__/unit/article-list.test.tsx` - Unit tests for ArticleList component
- `tests/__tests__/unit/pagination.test.tsx` - Unit tests for Pagination component
- `tests/__tests__/integration/homepage.test.ts` - Integration tests for homepage data fetching
- `tests/e2e/homepage.spec.ts` - E2E tests for homepage article list display

**Modified Files:**
- `app/page.tsx` - Updated homepage to display article list using Server Component pattern

## Senior Developer Review (AI)

### Reviewer
Travis

### Date
2025-11-14

### Outcome
**Approve** ✅

### Summary

Story 4.1 的实现质量很高，所有验收标准都已完整实现，代码遵循架构规范，测试覆盖全面。实现使用了 Next.js Server Components 的最佳实践，直接使用 Prisma 在 Server Component 中获取数据，避免了不必要的 HTTP 请求，提升了性能。所有组件都遵循了项目的代码规范和架构模式。

### Key Findings

**✅ 优点：**
- 所有验收标准都已完整实现并有证据支持
- 代码结构清晰，组件职责明确
- 使用了 Server Components 的最佳实践（直接使用 Prisma 而非 API 调用）
- 响应式设计实现良好，使用了 Tailwind CSS 的移动端优先方法
- 测试覆盖全面：26 个单元测试全部通过，集成测试和 E2E 测试都已实现
- 错误处理和加载状态实现完善
- 修复了嵌套 anchor 标签的 HTML 结构问题

**⚠️ 轻微改进建议（非阻塞）：**
- 可以考虑添加更多的 JSDoc 注释（虽然现有注释已经足够）
- 可以考虑添加更多的边界情况测试（虽然现有测试已经覆盖主要场景）

### Acceptance Criteria Coverage

| AC# | Description | Status | Evidence |
|-----|-------------|--------|----------|
| AC-4.1.1 | Given I visit the homepage, When the page loads, Then I see a list of published articles | ✅ IMPLEMENTED | `app/page.tsx:160-175` - HomePageContent fetches and displays articles via ArticleList component. `app/page.tsx:83-84` - Only PUBLISHED articles are fetched. |
| AC-4.1.2 | Each article shows title, excerpt, publish date, category, and tags | ✅ IMPLEMENTED | `components/article/ArticleCard.tsx:91-94` - Title displayed. `components/article/ArticleCard.tsx:98` - Excerpt displayed. `components/article/ArticleCard.tsx:81-83` - Date formatted with date-fns. `components/article/ArticleCard.tsx:143-150` - Category displayed. `components/article/ArticleCard.tsx:154-165` - Tags displayed. |
| AC-4.1.3 | Articles are sorted by publish date (newest first by default) | ✅ IMPLEMENTED | `app/page.tsx:98-100` - orderBy: { publishedAt: "desc" } |
| AC-4.1.4 | Articles are paginated (default 20 per page, max 100) | ✅ IMPLEMENTED | `app/page.tsx:156-157` - Default limit 20, max 100. `app/page.tsx:79-80` - Pagination calculation. `components/article/Pagination.tsx` - Full pagination component with Previous/Next buttons and page numbers. |
| AC-4.1.5 | The page is responsive (works on desktop, tablet, mobile) | ✅ IMPLEMENTED | `components/article/ArticleList.tsx:50` - `grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3` - Responsive grid. `components/article/Pagination.tsx:104` - `flex flex-col sm:flex-row` - Responsive pagination layout. |
| AC-4.1.6 | Loading states are displayed while fetching articles | ✅ IMPLEMENTED | `app/page.tsx:205-227` - HomePageLoading component with skeleton UI. `app/page.tsx:248-250` - Suspense boundary with loading fallback. |
| AC-4.1.7 | Empty state is displayed when no articles are available | ✅ IMPLEMENTED | `components/article/ArticleList.tsx:24-45` - Empty state with friendly message "暂无文章" and suggestion "请稍后再来查看新文章". |

**Summary:** 7 of 7 acceptance criteria fully implemented (100%)

### Task Completion Validation

| Task | Marked As | Verified As | Evidence |
|------|-----------|-------------|----------|
| Task 1: Create Homepage Server Component | ✅ Complete | ✅ VERIFIED COMPLETE | `app/page.tsx:242-252` - Server Component with Suspense. `app/page.tsx:74-142` - fetchArticles function using Prisma. `app/page.tsx:185-199` - Error handling. `app/page.tsx:248` - Suspense boundary. |
| Task 2: Create Article List Component | ✅ Complete | ✅ VERIFIED COMPLETE | `components/article/ArticleList.tsx` - Component created. `components/article/ArticleList.tsx:18-22` - Accepts articles array. `components/article/ArticleList.tsx:49-55` - Renders article cards. `components/article/ArticleList.tsx:24-45` - Handles empty state. |
| Task 3: Create Article Card Component | ✅ Complete | ✅ VERIFIED COMPLETE | `components/article/ArticleCard.tsx` - Component created. `components/article/ArticleCard.tsx:91-94` - Displays title. `components/article/ArticleCard.tsx:98` - Displays excerpt. `components/article/ArticleCard.tsx:81-83` - Formats date with date-fns. `components/article/ArticleCard.tsx:143-150` - Displays category. `components/article/ArticleCard.tsx:154-165` - Displays tags. `components/article/ArticleCard.tsx:91` - Title is clickable link. |
| Task 4: Implement Pagination Component | ✅ Complete | ✅ VERIFIED COMPLETE | `components/article/Pagination.tsx` - Client Component created. `components/article/Pagination.tsx:38-42` - Accepts pagination metadata. `components/article/Pagination.tsx:170-172` - Displays current page and total pages. `components/article/Pagination.tsx:106-119` - Previous/Next buttons. `components/article/Pagination.tsx:122-151` - Page number buttons with ellipsis. `components/article/Pagination.tsx:54-61` - Updates URL query parameters. `components/article/Pagination.tsx:107-118` - Handles edge cases (first/last page). `components/article/Pagination.tsx:104` - Responsive layout. |
| Task 5: Implement Responsive Design | ✅ Complete | ✅ VERIFIED COMPLETE | `components/article/ArticleList.tsx:50` - Uses Tailwind responsive breakpoints (md:, lg:). `components/article/ArticleList.tsx:50` - Mobile-first (grid-cols-1). `components/article/ArticleList.tsx:50` - Cards stack on mobile, grid on desktop. `components/article/Pagination.tsx:104` - Responsive flex layout. |
| Task 6: Implement Date Formatting | ✅ Complete | ✅ VERIFIED COMPLETE | `components/article/ArticleCard.tsx:2-3` - Imports date-fns and zhCN locale. `components/article/ArticleCard.tsx:81-83` - Formats date as "yyyy年MM月dd日" with Chinese locale. |
| Task 7: Implement Article Sorting | ✅ Complete | ✅ VERIFIED COMPLETE | `app/page.tsx:98-100` - orderBy: { publishedAt: "desc" } - Sorts by publish date descending. |
| Task 8: Add Loading States | ✅ Complete | ✅ VERIFIED COMPLETE | `app/page.tsx:248` - Suspense boundary. `app/page.tsx:205-227` - HomePageLoading component with skeleton UI. |
| Task 9: Handle Empty State | ✅ Complete | ✅ VERIFIED COMPLETE | `components/article/ArticleList.tsx:24-45` - Empty state with friendly message and suggestion. |
| Task 10: Add Error Handling | ✅ Complete | ✅ VERIFIED COMPLETE | `app/page.tsx:185-199` - Error state UI with user-friendly message. `app/page.tsx:138-141` - Database error handling in fetchArticles. |
| Task 11: Add Navigation to Article Detail | ✅ Complete | ✅ VERIFIED COMPLETE | `components/article/ArticleCard.tsx:91` - Title wrapped in Link component. `components/article/ArticleCard.tsx:91` - Navigates to `/articles/${slug}`. |
| Task 12: Write Tests | ✅ Complete | ✅ VERIFIED COMPLETE | `tests/__tests__/unit/article-card.test.tsx` - 12 unit tests for ArticleCard. `tests/__tests__/unit/article-list.test.tsx` - 4 unit tests for ArticleList. `tests/__tests__/unit/pagination.test.tsx` - 10 unit tests for Pagination. `tests/__tests__/integration/homepage.test.ts` - Integration tests for data fetching. `tests/e2e/homepage.spec.ts` - E2E tests for complete user flows. All tests passing (26 unit tests verified). |

**Summary:** 12 of 12 completed tasks verified (100%), 0 questionable, 0 false completions

### Test Coverage and Gaps

**✅ 测试覆盖情况：**

**单元测试：**
- ArticleCard: 12 个测试，覆盖所有字段显示、可选字段处理、导航功能
- ArticleList: 4 个测试，覆盖列表渲染、网格布局、空状态
- Pagination: 10 个测试，覆盖分页控件、边界情况、URL 参数处理、响应式设计

**集成测试：**
- Homepage: 测试数据获取、排序、分页逻辑

**E2E 测试：**
- Homepage: 完整的用户流程测试，包括文章列表显示、导航、分页、响应式设计、空状态

**测试质量：**
- 所有测试都使用适当的 mocking（Next.js navigation, date-fns）
- 测试覆盖了边界情况和错误处理
- 测试遵循了项目的测试模式（React Testing Library, Playwright）

**无测试覆盖缺口：** 所有验收标准都有对应的测试覆盖。

### Architectural Alignment

**✅ 架构对齐验证：**

1. **Server Components 使用：** ✅
   - `app/page.tsx` 正确使用 Server Component
   - 直接使用 Prisma 而非 API 调用（更高效）

2. **组件组织：** ✅
   - 组件位于 `components/article/` 目录
   - 命名遵循 PascalCase 约定
   - Server Components 和 Client Components 正确分离

3. **样式架构：** ✅
   - 使用 Tailwind CSS
   - 移动端优先设计
   - 使用响应式断点（sm, md, lg, xl）

4. **错误处理：** ✅
   - 实现了用户友好的错误消息
   - 错误日志记录（console.error）

5. **日期格式化：** ✅
   - 使用 date-fns 库
   - 使用中文 locale
   - 格式符合要求

6. **导航模式：** ✅
   - 使用 Next.js Link 组件
   - 客户端导航实现正确

**无架构违规：** 实现完全符合架构规范和约束。

### Security Notes

**✅ 安全检查：**

1. **数据访问控制：** ✅
   - 只获取 PUBLISHED 状态的文章（`app/page.tsx:84`）
   - 无敏感数据暴露

2. **输入验证：** ✅
   - 分页参数验证（`app/page.tsx:156-157`）
   - 限制最大页面大小（100）

3. **XSS 防护：** ✅
   - React 自动转义内容
   - 使用 Next.js Link 组件（安全导航）

4. **SQL 注入：** ✅
   - 使用 Prisma ORM（参数化查询）

**无安全问题发现：** 实现遵循了安全最佳实践。

### Best-Practices and References

**✅ 最佳实践遵循：**

1. **Next.js App Router：**
   - 正确使用 Server Components 进行 SSR
   - 使用 Suspense 处理加载状态
   - 参考：https://nextjs.org/docs/app/building-your-application/routing/loading-ui-and-streaming

2. **React 组件模式：**
   - 组件职责单一
   - Props 接口定义清晰
   - 使用 TypeScript 类型安全

3. **性能优化：**
   - Server Components 减少客户端 JavaScript
   - 直接数据库查询避免 HTTP 开销
   - 响应式图片和懒加载（如需要）

4. **可访问性：**
   - 语义化 HTML（article, header 标签）
   - 链接可键盘导航
   - 适当的 ARIA 标签（可进一步改进）

5. **代码质量：**
   - JSDoc 注释完整
   - 类型定义清晰
   - 错误处理完善

### Action Items

**代码更改要求：**
无阻塞性问题，所有验收标准已实现。

**建议性说明：**
- Note: 可以考虑为 ArticleCard 组件添加更多的可访问性属性（如 aria-label），但这不是阻塞性问题
- Note: 可以考虑添加更多的边界情况测试（如大量文章的分页性能），但现有测试已经足够
- Note: 可以考虑添加文章卡片的键盘导航增强（如 Enter 键触发导航），但现有实现已经可用

### Change Log

**2025-11-14:**
- Senior Developer Review notes appended
- Review outcome: Approve
- All acceptance criteria verified and implemented
- All tasks verified as complete
- No blocking issues found

