# Epic 5 重新设计 - 已测试功能保护清单

**创建日期：** 2025-11-17  
**负责人：** PM (John)  
**目的：** 确保重新设计不影响已通过回归测试的功能

---

## 🛡️ 保护原则

### 核心原则

1. **最小化变更范围**
   - 只修改留言相关组件
   - 不修改数据库模型
   - 不修改 Server Actions 接口
   - 不修改其他 Epic 的代码

2. **向后兼容**
   - 保持现有 API 接口不变
   - 保持数据模型不变
   - 保持组件接口兼容

3. **隔离测试**
   - 在实施前备份所有相关文件
   - 使用功能分支进行开发
   - 执行完整的回归测试

---

## ✅ 已测试功能清单（需保护）

### Epic 1: 项目基础架构（5/5 通过）

**测试用例：**
- ✅ TC-1.1: 项目启动和运行
- ✅ TC-1.2: 数据库连接测试
- ✅ TC-1.3: Prisma 操作测试
- ✅ TC-1.4: Vercel 部署验证
- ⚠️ TC-1.5: 存储抽象层功能测试（部分通过）

**保护措施：**
- ❌ **不修改** `lib/db/prisma.ts`
- ❌ **不修改** `prisma/schema.prisma`（Comment 模型除外，但保持结构不变）
- ❌ **不修改** `next.config.ts`
- ❌ **不修改** `lib/storage/` 目录下的文件

**验证方法：**
- 执行 `npm run build` 确保构建成功
- 验证数据库连接正常
- 验证 Prisma 操作正常

---

### Epic 2: 用户认证和授权（8/8 通过）

**测试用例：**
- ✅ TC-2.1: 邮箱注册功能
- ✅ TC-2.2: GitHub OAuth 登录
- ✅ TC-2.3: Google OAuth 登录
- ✅ TC-2.4: 邮箱密码登录
- ✅ TC-2.5: JWT 认证验证
- ✅ TC-2.6: 角色权限检查（admin vs user）
- ✅ TC-2.7: 用户资料管理
- ✅ TC-2.8: 路由保护

**保护措施：**
- ❌ **不修改** `app/api/auth/[...nextauth]/route.ts`
- ❌ **不修改** `lib/auth/` 目录下的文件
- ❌ **不修改** `middleware.ts`（除非明确需要）
- ❌ **不修改** `app/login/page.tsx`
- ❌ **不修改** `app/register/page.tsx`
- ❌ **不修改** `app/profile/page.tsx`

**验证方法：**
- 测试登录功能（邮箱、GitHub、Google）
- 测试注册功能
- 测试路由保护（访问 `/admin` 需要登录）
- 测试用户资料页面
- 验证会话管理正常

---

### Epic 3: 内容创作和管理（12/13 通过）

**测试用例：**
- ✅ TC-3.5: 图片拖拽上传
- ✅ TC-3.6: 图片粘贴上传
- ✅ TC-3.7: 文章创建（完整流程）
- ✅ TC-3.8: 文章编辑（完整流程）
- ✅ TC-3.9: 文章删除
- ✅ TC-3.10: 分类管理
- ✅ TC-3.11: 标签管理
- ✅ TC-3.12: 文章发布/草稿状态切换
- ✅ TC-3.13: 媒体管理功能

**保护措施：**
- ❌ **不修改** `app/admin/articles/` 目录下的文件
- ❌ **不修改** `lib/actions/article.ts`
- ❌ **不修改** `components/editor/` 目录下的文件
- ❌ **不修改** `app/api/articles/` 目录下的文件
- ❌ **不修改** `app/api/upload/route.ts`
- ❌ **不修改** `app/api/media/` 目录下的文件

**验证方法：**
- 测试文章创建功能
- 测试文章编辑功能
- 测试文章删除功能
- 测试图片上传功能（拖拽、粘贴）
- 测试分类和标签管理
- 测试媒体管理页面

---

### Epic 4: 内容展示（9/9 通过）

**测试用例：**
- ✅ TC-4.5: 分类筛选功能
- ✅ TC-4.6: 标签筛选功能
- ✅ TC-4.7: 分页功能
- ✅ TC-4.8: 代码语法高亮显示
- ✅ TC-4.9: 响应式设计验证

**保护措施：**
- ❌ **不修改** `app/page.tsx`（首页）
- ❌ **不修改** `app/articles/page.tsx`（文章列表）
- ❌ **不修改** `app/articles/category/[slug]/page.tsx`
- ❌ **不修改** `app/articles/tag/[slug]/page.tsx`
- ❌ **不修改** `components/article/` 目录下的文件（除了可能需要的 ArticleDetail）
- ⚠️ **谨慎修改** `app/articles/[slug]/page.tsx`（只取消注释留言区域，不修改其他部分）

**验证方法：**
- 测试首页文章列表显示
- 测试文章详情页显示（不包括留言功能）
- 测试分类筛选功能
- 测试标签筛选功能
- 测试分页功能
- 测试代码语法高亮
- 测试响应式设计

---

### Epic 6: 后台管理界面（8/9 通过）

**测试用例：**
- ✅ TC-6.1: 后台管理界面访问
- ✅ TC-6.2: 媒体管理页面
- ✅ TC-6.3: 文章管理列表显示
- ✅ TC-6.4: 文章状态筛选
- ✅ TC-6.5: 文章搜索功能
- ✅ TC-6.6: 文章删除功能
- ✅ TC-6.7: 后台文章创建集成
- ✅ TC-6.8: 后台文章编辑集成
- ✅ TC-6.9: 导航菜单功能

**保护措施：**
- ❌ **不修改** `app/admin/` 目录下的文件（除了可能需要的布局）
- ❌ **不修改** `components/admin/` 目录下的文件
- ❌ **不修改** `app/api/admin/` 目录下的文件

**验证方法：**
- 测试后台管理界面访问
- 测试文章管理列表
- 测试文章筛选和搜索
- 测试后台文章创建和编辑
- 测试导航菜单

---

## 🔍 修改范围清单

### ✅ 允许修改的文件

1. **留言相关组件（新增/优化）**
   - ✅ `components/comment/CommentsSection.tsx`（新增）
   - ✅ `components/comment/CommentFormWrapper.tsx`（新增）
   - ✅ `components/comment/CommentForm.tsx`（优化 - 接收 session prop）
   - ✅ `components/comment/CommentItem.tsx`（优化 - 接收 session prop）
   - ✅ `components/comment/CommentList.tsx`（优化 - 错误处理）

2. **页面集成**
   - ✅ `app/articles/[slug]/page.tsx`（取消注释留言区域，使用新组件）

### ❌ 禁止修改的文件

1. **数据库和模型**
   - ❌ `prisma/schema.prisma`（Comment 模型结构保持不变）
   - ❌ `lib/db/prisma.ts`

2. **Server Actions**
   - ❌ `lib/actions/comment.ts`（接口保持不变）

3. **验证和工具**
   - ❌ `lib/validations/comment.ts`
   - ❌ `lib/utils/comment-depth.ts`

4. **其他 Epic 的文件**
   - ❌ 所有 `app/admin/` 目录下的文件
   - ❌ 所有 `app/api/` 目录下的文件（除了可能需要的测试）
   - ❌ 所有 `components/article/` 目录下的文件（除了 ArticleDetail 的集成）
   - ❌ 所有 `components/editor/` 目录下的文件
   - ❌ 所有 `lib/actions/article.ts`
   - ❌ 所有 `lib/auth/` 目录下的文件
   - ❌ `middleware.ts`

---

## 🧪 回归测试计划

### 测试前准备

1. **备份代码**
   ```bash
   git checkout -b feature/epic5-comment-redesign
   git add .
   git commit -m "Backup: Before Epic 5 redesign"
   ```

2. **创建测试分支**
   ```bash
   git checkout -b feature/epic5-comment-redesign-test
   ```

### 测试执行顺序

#### 阶段 1: 功能隔离测试（只测试留言功能）

1. **留言创建测试**
   - [ ] 登录用户创建留言
   - [ ] 匿名用户创建留言
   - [ ] 留言内容验证

2. **留言回复测试**
   - [ ] 回复顶级留言
   - [ ] 嵌套回复（3 层）
   - [ ] 最大深度限制

3. **留言删除测试**
   - [ ] 管理员删除留言
   - [ ] 级联删除回复

4. **留言显示测试**
   - [ ] 留言列表显示
   - [ ] 嵌套回复显示
   - [ ] 空列表提示

#### 阶段 2: 集成测试（验证不影响其他功能）

1. **Epic 1 验证**
   - [ ] 项目启动正常
   - [ ] 数据库连接正常
   - [ ] Prisma 操作正常

2. **Epic 2 验证**
   - [ ] 登录功能正常
   - [ ] 注册功能正常
   - [ ] 路由保护正常
   - [ ] 会话管理正常

3. **Epic 3 验证**
   - [ ] 文章创建正常
   - [ ] 文章编辑正常
   - [ ] 文章删除正常
   - [ ] 图片上传正常

4. **Epic 4 验证**
   - [ ] 首页显示正常
   - [ ] 文章详情页显示正常（不包括留言）
   - [ ] 分类筛选正常
   - [ ] 标签筛选正常
   - [ ] 分页功能正常

5. **Epic 6 验证**
   - [ ] 后台管理界面正常
   - [ ] 文章管理列表正常
   - [ ] 文章筛选和搜索正常

#### 阶段 3: 端到端测试（完整用户流程）

1. **完整文章阅读流程**
   - [ ] 访问首页
   - [ ] 查看文章列表
   - [ ] 查看文章详情
   - [ ] 查看留言（新功能）
   - [ ] 创建留言（新功能）

2. **完整文章管理流程**
   - [ ] 登录后台
   - [ ] 创建文章
   - [ ] 编辑文章
   - [ ] 发布文章
   - [ ] 查看文章（前台）
   - [ ] 查看留言（新功能）

---

## 🚨 风险控制措施

### 风险 1: 意外修改其他文件

**控制措施：**
- 使用 Git 分支隔离开发
- 代码审查时检查修改的文件列表
- 使用 `git diff` 检查所有变更

### 风险 2: 破坏现有功能

**控制措施：**
- 执行完整的回归测试
- 在测试环境先验证
- 逐步部署到生产环境

### 风险 3: 性能问题

**控制措施：**
- 监控页面加载时间
- 测试大量留言的场景
- 优化数据库查询

---

## ✅ 验收检查清单

### 代码检查

- [ ] 只修改了允许修改的文件
- [ ] 没有修改禁止修改的文件
- [ ] 代码符合项目规范
- [ ] 没有引入新的依赖

### 功能检查

- [ ] 留言功能正常工作
- [ ] 所有已测试功能仍然正常
- [ ] 没有引入新的错误
- [ ] 性能没有明显下降

### 测试检查

- [ ] 所有回归测试用例通过
- [ ] 新的留言功能测试用例通过
- [ ] 端到端测试通过

---

**最后更新：** 2025-11-17  
**负责人：** PM (John)  
**状态：** 📋 待实施时使用

