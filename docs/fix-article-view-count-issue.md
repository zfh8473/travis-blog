# ä¿®å¤æ–‡ç« é˜…è¯»æ•°è®¡æ•°é—®é¢˜

**é—®é¢˜æ—¥æœŸï¼š** 2025-11-17  
**çŠ¶æ€ï¼š** ğŸ”´ è°ƒæŸ¥ä¸­

---

## ğŸ“‹ é—®é¢˜æè¿°

**é—®é¢˜è¡¨ç°ï¼š**
- æ–‡ç« è¯¦æƒ…é¡µé¢æ˜¾ç¤ºé˜…è¯»æ•°ï¼Œä½†ç‚¹å‡»å¤šæ¬¡åé˜…è¯»æ•°ä»ç„¶æ˜¯ 0
- é˜…è¯»æ•°ä¸ä¼šéšç€é¡µé¢è®¿é—®è€Œå¢åŠ 

**è‡ªåŠ¨åŒ–æµ‹è¯•ç»“æœï¼š**
1. âœ… API è·¯ç”±å­˜åœ¨ï¼š`/api/articles/[slug]/views`
2. âŒ API è¯·æ±‚æ²¡æœ‰è¢«è§¦å‘ï¼ˆæµ‹è¯•ä¸­ `viewCountRequest` ä¸º nullï¼‰
3. âŒ `[data-article-views]` å…ƒç´ æœªæ‰¾åˆ°
4. âŒ API è°ƒç”¨æ¬¡æ•°ä¸º 0
5. âŒ ç›´æ¥è°ƒç”¨ API è¿”å› 500 Internal Server Error

---

## ğŸ” é—®é¢˜åˆ†æ

### 1. API è·¯ç”±é—®é¢˜

**æµ‹è¯•ç»“æœï¼š**
```bash
curl -X POST http://localhost:3000/api/articles/server-printer/views
# è¿”å›: Internal Server Error
```

**å¯èƒ½åŸå› ï¼š**
- Next.js åŠ¨æ€è·¯ç”±å‚æ•°è§£æé—®é¢˜
- Prisma æŸ¥è¯¢å¤±è´¥
- æ•°æ®åº“è¿æ¥é—®é¢˜

### 2. å®¢æˆ·ç«¯ç»„ä»¶é—®é¢˜

**æµ‹è¯•ç»“æœï¼š**
- `ArticleViewCounter` ç»„ä»¶æ²¡æœ‰è§¦å‘ API è°ƒç”¨
- ç»„ä»¶å¯èƒ½æ²¡æœ‰æ­£ç¡®æ¸²æŸ“

**å¯èƒ½åŸå› ï¼š**
- Client Component åœ¨ Server Component ä¸­çš„æ¸²æŸ“é—®é¢˜
- `useEffect` æ²¡æœ‰æ­£ç¡®æ‰§è¡Œ
- ç»„ä»¶è¢« Suspense è¾¹ç•Œé˜»æ­¢

### 3. DOM å…ƒç´ é—®é¢˜

**æµ‹è¯•ç»“æœï¼š**
- `[data-article-views]` å…ƒç´ æœªæ‰¾åˆ°

**å¯èƒ½åŸå› ï¼š**
- `data-article-views` å±æ€§æ²¡æœ‰æ­£ç¡®æ·»åŠ åˆ° DOM
- å…ƒç´ é€‰æ‹©å™¨ä¸æ­£ç¡®

---

## ğŸ”§ ä¿®å¤æ–¹æ¡ˆ

### æ–¹æ¡ˆ 1: ä¿®å¤ API è·¯ç”±å‚æ•°è§£æ

**é—®é¢˜ï¼š** Next.js 15 ä¸­åŠ¨æ€è·¯ç”±å‚æ•°æ˜¯ Promise

**ä¿®å¤ï¼š**
```typescript
export async function POST(
  request: NextRequest,
  { params }: { params: Promise<{ slug: string }> }
) {
  const { slug } = await params; // âœ… æ­£ç¡®ï¼šawait params
  // ...
}
```

### æ–¹æ¡ˆ 2: ç¡®ä¿ Client Component æ­£ç¡®æ¸²æŸ“

**é—®é¢˜ï¼š** Client Component å¯èƒ½è¢« Suspense é˜»æ­¢

**ä¿®å¤ï¼š**
- å°† `ArticleViewCounter` ç§»åˆ° Suspense è¾¹ç•Œå¤–
- æˆ–è€…ç¡®ä¿å®ƒåœ¨æ­£ç¡®çš„æ¸²æŸ“ä½ç½®

### æ–¹æ¡ˆ 3: æ·»åŠ è°ƒè¯•æ—¥å¿—

**æ·»åŠ è¯¦ç»†çš„æ—¥å¿—ï¼š**
- API è·¯ç”±ä¸­æ·»åŠ è¯·æ±‚æ—¥å¿—
- å®¢æˆ·ç«¯ç»„ä»¶ä¸­æ·»åŠ æ‰§è¡Œæ—¥å¿—
- æµ‹è¯•ä¸­æ·»åŠ ç½‘ç»œè¯·æ±‚ç›‘æ§

---

## ğŸ“ æµ‹è¯•è®¡åˆ’

### è‡ªåŠ¨åŒ–æµ‹è¯•

1. âœ… åˆ›å»º E2E æµ‹è¯•ï¼š`tests/e2e/article-view-count.spec.ts`
2. âœ… æµ‹è¯• API è·¯ç”±æ˜¯å¦å¯è®¿é—®
3. âœ… æµ‹è¯•å®¢æˆ·ç«¯ç»„ä»¶æ˜¯å¦è§¦å‘ API è°ƒç”¨
4. âœ… æµ‹è¯• DOM å…ƒç´ æ˜¯å¦æ­£ç¡®æ˜¾ç¤º
5. âœ… æµ‹è¯•é˜…è¯»æ•°æ˜¯å¦æ­£ç¡®å¢åŠ 

### æ‰‹åŠ¨æµ‹è¯•

1. æ‰“å¼€æµè§ˆå™¨å¼€å‘è€…å·¥å…·
2. è®¿é—®æ–‡ç« è¯¦æƒ…é¡µé¢
3. æ£€æŸ¥ Network æ ‡ç­¾é¡µæ˜¯å¦æœ‰ `/api/articles/[slug]/views` è¯·æ±‚
4. æ£€æŸ¥ Console æ˜¯å¦æœ‰é”™è¯¯æˆ–æ—¥å¿—
5. æ£€æŸ¥é˜…è¯»æ•°æ˜¯å¦æ›´æ–°

---

## ğŸ¯ ä¸‹ä¸€æ­¥

1. **ä¿®å¤ API è·¯ç”± 500 é”™è¯¯**
   - æ£€æŸ¥æœåŠ¡å™¨æ—¥å¿—
   - ä¿®å¤å‚æ•°è§£æé—®é¢˜
   - æµ‹è¯• API è·¯ç”±

2. **ä¿®å¤å®¢æˆ·ç«¯ç»„ä»¶**
   - ç¡®ä¿ç»„ä»¶æ­£ç¡®æ¸²æŸ“
   - æ·»åŠ è°ƒè¯•æ—¥å¿—
   - æµ‹è¯• API è°ƒç”¨

3. **éªŒè¯ä¿®å¤**
   - è¿è¡Œè‡ªåŠ¨åŒ–æµ‹è¯•
   - æ‰‹åŠ¨æµ‹è¯•é˜…è¯»æ•°åŠŸèƒ½
   - ç¡®è®¤é˜…è¯»æ•°æ­£ç¡®å¢åŠ 

---

---

## âœ… ä¿®å¤è®°å½•

### 2025-11-17: ä¿®å¤ä¸­é—´ä»¶æ‹¦æˆªé—®é¢˜

**é—®é¢˜ï¼š**
- `/api/articles/[slug]/views` è¢«ä¸­é—´ä»¶æ‹¦æˆªï¼Œè¿”å› 401 é”™è¯¯
- ä¸­é—´ä»¶é…ç½®ä¸­ `/api/articles` éœ€è¦ç®¡ç†å‘˜æƒé™ï¼Œä½†é˜…è¯»æ•°ç«¯ç‚¹æ˜¯å…¬å¼€çš„

**ä¿®å¤ï¼š**
- åœ¨ `getMatchingRule` å‡½æ•°ä¸­æ·»åŠ ç‰¹æ®Šå¤„ç†ï¼Œæ’é™¤ `/api/articles/[slug]/views` è·¯å¾„
- ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…åŠ¨æ€è·¯ç”±ï¼š`/^\/api\/articles\/[^/]+\/views$/`

**ä»£ç å˜æ›´ï¼š**
```typescript
// middleware.ts
// Special case: exclude /api/articles/[slug]/views (public endpoint for view counting)
if (pathname.match(/^\/api\/articles\/[^/]+\/views$/)) {
  continue;
}
```

### 2025-11-17: æ·»åŠ è¯¦ç»†é”™è¯¯æ—¥å¿—

**é—®é¢˜ï¼š**
- API è¿”å› 500 é”™è¯¯ï¼Œä½†åŸå› ä¸æ˜

**ä¿®å¤ï¼š**
- æ·»åŠ è¯¦ç»†çš„é”™è¯¯æ—¥å¿—ï¼ŒåŒ…æ‹¬ slug è§£æã€æ•°æ®åº“æŸ¥è¯¢ç­‰æ­¥éª¤
- ä¿®å¤åµŒå¥—çš„ try-catch å—ç»“æ„
- ç»Ÿä¸€é”™è¯¯å¤„ç†é€»è¾‘

**ä»£ç å˜æ›´ï¼š**
```typescript
// æ·»åŠ æ—¥å¿—å‰ç¼€ [Views API] ä»¥ä¾¿è¯†åˆ«
console.log("[Views API] Received slug:", slug);
console.error("[Views API] Error in POST handler:", error);
```

### 2025-11-17: ä¿®å¤æ‰§è¡Œæ—¶æœºå’Œ DOM æ›´æ–°é—®é¢˜

**é—®é¢˜ï¼š**
- `ArticleViewCounter` åœ¨ `ArticleDetail` ä¹‹å‰æ¸²æŸ“
- `useEffect` å¯èƒ½åœ¨ DOM å…ƒç´ è¿˜æ²¡æœ‰æ¸²æŸ“å®Œæˆæ—¶å°±æ‰§è¡Œ
- `document.querySelector` æ‰¾ä¸åˆ°å…ƒç´ 
- DOM æ›´æ–°æ—¶æ›¿æ¢äº†æ•´ä¸ªå†…å®¹ï¼ŒåŒ…æ‹¬ SVG å›¾æ ‡

**ä¿®å¤ï¼š**
1. å°† `ArticleViewCounter` ç§»åˆ° `ArticleDetail` ä¹‹åï¼Œç¡®ä¿ DOM å·²ç»æ¸²æŸ“
2. æ·»åŠ ç­‰å¾…æœºåˆ¶ï¼Œä½¿ç”¨ `setTimeout` é‡è¯•ç›´åˆ°æ‰¾åˆ°å…ƒç´ ï¼ˆæœ€å¤šç­‰å¾…å‡ ç§’ï¼‰
3. æ”¹è¿› DOM æ›´æ–°é€»è¾‘ï¼Œä¿ç•™ SVG å›¾æ ‡ï¼Œåªæ›´æ–°æ–‡æœ¬éƒ¨åˆ†
4. æ·»åŠ è¯¦ç»†çš„è°ƒè¯•æ—¥å¿—ï¼Œä½¿ç”¨ `[ViewCounter]` å‰ç¼€

**ä»£ç å˜æ›´ï¼š**
```typescript
// ç­‰å¾…å…ƒç´ å‡ºç°
const waitForElementAndIncrement = () => {
  const viewsElement = document.querySelector('[data-article-views]');
  if (!viewsElement) {
    setTimeout(waitForElementAndIncrement, 100);
    return;
  }
  // æ‰¾åˆ°å…ƒç´ åæ‰§è¡Œ API è°ƒç”¨
};

// æ›´æ–° DOM æ—¶ä¿ç•™ SVG
const svgElement = updatedElement.querySelector('svg');
if (svgElement) {
  updatedElement.innerHTML = '';
  updatedElement.appendChild(svgElement);
  updatedElement.appendChild(document.createTextNode(` ${views} æ¬¡é˜…è¯»`));
}
```

**æœ€åæ›´æ–°ï¼š** 2025-11-17  
**è´Ÿè´£äººï¼š** Dev

